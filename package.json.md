# NPM Scripts Documentation - ShiftBook

## Index
- [Startup Scripts](#startup-scripts)
- [Build Scripts](#build-scripts)
- [Deployment Scripts](#deployment-scripts)
- [Testing Scripts](#testing-scripts)
- [Database Scripts](#database-scripts)
- [Health Check Scripts](#health-check-scripts)
- [Performance Scripts](#performance-scripts)
- [Help System](#help-system)
- [CDS Configuration](#cds-configuration)
- [Best Practices](#best-practices)
- [Scripts by Development Phase](#scripts-by-development-phase)
- [Essential Commands Summary](#essential-commands-summary)
- [Emergency Commands](#emergency-commands)

---

## Startup Scripts

### `start`
```bash
npm start
```
**Command:** `cds serve csn.json`

**Purpose:** Starts the server in production mode using precompiled CSN model.

**When to use:**
- In production (Cloud Foundry/BTP)
- When you already have the `csn.json` file generated by build
- ‚ùå DO NOT use in local development (doesn't detect changes)

**Prerequisites:** Must have run `npm run build` previously

---

### `start:local`
```bash
npm run start:local
```
**Command:** `cross-env NODE_ENV=development cds serve`

**Purpose:** Starts the server in local development mode.

**Features:**
- Compiles CDS models in real-time
- Uses SQLite as database
- Enables dummy users (alice, bob, admin, operator)
- Does not require XSUAA authentication

**When to use:**
- Quick local development
- Manual testing without constant rebuilds

---

### `watch`
```bash
npm run watch
```
**Command:** `cds watch`

**Purpose:** Development mode with automatic hot-reload.

**Features:**
- Detects changes in `.cds`, `.js`, `.ts` files
- Automatically reloads the server
- Ideal for iterative development

---

### `dev`
```bash
npm run dev
```
**Command:** `npm run setup:dev-data && cds watch`

**Purpose:** Starts development with preloaded test data.

**Sequence:**
1. Runs `setup-dev-data.js` (loads mock data)
2. Starts `cds watch`

---

### `dev:test`
```bash
npm run dev:test
```
**Command:** `npm run setup:dev-data && cross-env CDS_ENV=test cds watch`

**Purpose:** Development with test configuration (in-memory database).

---

### `hybrid`
```bash
npm run hybrid
```
**Command:** `cross-env CDS_ENV=hybrid cds run`

**Purpose:** Hybrid mode - local development with real HANA.

**Configuration:**
- Database: HANA (real connection)
- Authentication: XSUAA
- Connection pool: 15 min, 75 max

---

### `prod`
```bash
npm run prod
```
**Command:** `cross-env CDS_ENV=production cds serve`

**Purpose:** Production simulation locally (requires HANA).

---

## Build Scripts

### `build`
```bash
npm run build
```
**Command:** `npm run clean && cds build --production && npm run build:ts && npm run copy:extras && npm run cleanup:mock`

**Purpose:** Full production build.

**Sequence:**
1. `clean` - Removes `gen/` folder
2. `cds build --production` - Generates CSN and HANA artifacts
3. `build:ts` - Compiles TypeScript
4. `copy:extras` - Copies necessary files to `gen/`
5. `cleanup:mock` - Removes mock data

**Output:** `gen/` folder ready for deployment

---

### `build:dev`
```bash
npm run build:dev
```
**Command:** `npm run clean && npm run build:ts && npm run copy:files`

**Purpose:** Lightweight build for development (TypeScript only).

---

### `build:ts`
```bash
npm run build:ts
```
**Command:** `tsc`

**Purpose:** Compiles TypeScript files to JavaScript using `tsconfig.json`.

---

### `build:cf`
```bash
npm run build:cf
```
**Command:** `npm run build:prod && npm run clean:typescript`

**Purpose:** Build specific for Cloud Foundry.

**Extra:** Removes `.ts` files from output to reduce size.

---

### `build:mtar`
```bash
npm run build:mtar
```
**Command:** `npm run build:cf && mbt build`

**Purpose:** Full build + `.mtar` file generation.

**Output:** `mta_archives/shiftbook_1.0.0.mtar`

---

### `prebuild`, `prebuild:cf`, `prebuild:mtar`
**Command:** `npm run cleanup:mock`

**Purpose:** Automatic hooks that run before builds to clean mock data.

---

### `clean`
```bash
npm run clean
```
**Command:** `rm -rf gen/`

**Purpose:** Completely removes the generated build folder.

---

### `cleanup:mock`
```bash
npm run cleanup:mock
```
**Command:** `npm install glob rimraf --save-dev --silent && node cleanMock.js`

**Purpose:** Runs the script that removes mock data files before deployment.

---

### `cleanup:ts`
```bash
npm run cleanup:ts
```
**Command:** `npx rimraf gen/srv/srv/**/*.ts`

**Purpose:** Removes TypeScript files from build (only leaves `.js`).

---

### `copy:extras`
**Command:** Copies multiple files and folders to `gen/`

**Purpose:** Copies all necessary files for production:
- Generated CDS models (`@cds-models`)
- Translation files (`_i18n`)
- Configurations (`package.json`, `package-lock.json`)
- Services and libraries
- Database (excluding backups and dev data)

---

### `copy:files`
**Command:** Copies specific files for development

**Purpose:** Copies only `package.json` and `server.js` for development builds.

---

## Deployment Scripts

### `deploy`
```bash
npm run deploy
```
**Command:** `npm run build:mta && cf deploy mta_archives/shiftbook_1.0.0.mtar --retries 1`

**Purpose:** Full build + deployment to Cloud Foundry.

**Sequence:**
1. Generates the `.mtar` file
2. Deploys it using CF CLI

**Prerequisites:** 
- CF CLI installed
- Active session (`cf login`)

---

### `undeploy`
```bash
npm run undeploy
```
**Command:** `cf undeploy shiftbook --delete-services --delete-service-keys`

**Purpose:** Completely removes the application from Cloud Foundry.

**‚ö†Ô∏è CAUTION:** 
- Deletes the application
- Deletes associated services (HANA, XSUAA, etc.)
- Deletes service keys

---

## Testing Scripts

### `jest`
```bash
npm run jest
```
**Command:** `jest --runInBand`

**Purpose:** Runs all tests with Jest in sequential mode.

**`--runInBand`:** Runs tests one by one (avoids concurrency issues with DB).

---

### `jest:unit`
```bash
npm run jest:unit
```
**Command:** `jest test/unit --runInBand`

**Purpose:** Runs only unit tests in `test/unit/`.

---

### `jest:coverage`
```bash
npm run jest:coverage
```
**Command:** `jest test/unit --coverage --runInBand`

**Purpose:** Unit tests + coverage report.

**Output:** `coverage/` folder with HTML reports.

---

### `jest:service`
```bash
npm run jest:service
```
**Command:** `jest test/service --runInBand`

**Purpose:** Tests for CDS services (handlers, actions, functions).

---

### `jest:workflow`
```bash
npm run jest:workflow
```
**Command:** `jest test/workflow --runInBand`

**Purpose:** Tests for complete workflows.

---

### `jest:integration`
```bash
npm run jest:integration
```
**Command:** `jest test/integration --runInBand`

**Purpose:** Integration tests (multiple components working together).

---

### `jest:e2e`
```bash
npm run jest:e2e
```
**Command:** `jest test/e2e --runInBand`

**Purpose:** End-to-end tests (simulate complete user flow).

---

### `jest:coverage:report`
```bash
npm run jest:coverage:report
```
**Command:** `node scripts/generate-coverage-report.js`

**Purpose:** Generates custom coverage report.

---

### `jest:watch`
```bash
npm run jest:watch
```
**Command:** `jest --watch`

**Purpose:** Watch mode - reruns tests on changes.

---

### `jest:ci`
```bash
npm run jest:ci
```
**Command:** `jest test/unit --ci --coverage --runInBand`

**Purpose:** Tests for CI/CD pipelines.

**`--ci`:** CI mode (no cache, optimized output for logs).

---

### `jest:clean`
```bash
npm run jest:clean
```
**Command:** `jest --clearCache`

**Purpose:** Clears Jest cache (useful when there are strange issues).

---

### `jest:debug`
```bash
npm run jest:debug
```
**Command:** `echo 'Running test debugging cleanup...' && npm run clean && npm run jest:clean && echo 'Ready for testing!'`

**Purpose:** Complete cleanup for test debugging.

---

## üóÑÔ∏è Scripts de Base de Datos

### `db:deploy`
```bash
npm run db:deploy
```
**Command:** `cds deploy`

**Purpose:** Deploys the data model using current environment configuration.

---

### `db:deploy:dev`
```bash
npm run db:deploy:dev
```
**Command:** `npm run setup:dev-data && cross-env CDS_ENV=development cds deploy --to sqlite:db/shiftbook-dev.db`

**Purpose:** Creates SQLite development database + loads data.

**Output:** `db/shiftbook-dev.db`

---

### `db:deploy:test`
```bash
npm run db:deploy:test
```
**Command:** `cross-env CDS_ENV=test cds deploy --to sqlite::memory:`

**Purpose:** Creates in-memory database for tests.

---

### `db:deploy:hybrid`
```bash
npm run db:deploy:hybrid
```
**Command:** `cross-env CDS_ENV=hybrid cds deploy --to hana`

**Purpose:** Deploys schema to HANA in hybrid mode.

---

### `db:deploy:prod`
```bash
npm run db:deploy:prod
```
**Command:** `cross-env CDS_ENV=production cds deploy --to hana`

**Purpose:** Deploys schema to HANA in production.

---

### `setup:dev-data`
```bash
npm run setup:dev-data
```
**Command:** `node scripts/setup-dev-data.js`

**Purpose:** Runs script that loads development/test data.

---

## Health Check Scripts

### `health:check`
```bash
npm run health:check
```
**Purpose:** Informative message to use other health check commands.

---

### `health:simple`
```bash
npm run health:simple
```
**Purpose:** Informative message to use other simple health check commands.

---

### `health:check:local`
```bash
npm run health:check:local
```
**Command:** `curl -f http://localhost:4004/health || echo 'Local health check failed'`

**Purpose:** Checks health of local server.

**Endpoint:** `/health` (complete with metrics)

---

### `health:simple:local`
```bash
npm run health:simple:local
```
**Command:** `curl -f http://localhost:4004/health/simple || echo 'Local simple health check failed'`

**Purpose:** Checks basic health of local server.

**Endpoint:** `/health/simple` (only UP/DOWN status)

---

### `health:check:dev`
```bash
npm run health:check:dev
```
**Command:** `curl -f ${HEALTH_CHECK_URL:-https://shiftbook-cap-dev.${CF_DOMAIN:-cfapps.eu10.hana.ondemand.com}/health} || echo 'Dev health check failed'`

**Purpose:** Checks health of development environment in BTP.

**Environment variables:**
- `HEALTH_CHECK_URL`: Custom URL (optional)
- `CF_DOMAIN`: Cloud Foundry domain (default: `cfapps.eu10.hana.ondemand.com`)

---

### `health:check:test`
```bash
npm run health:check:test
```
**Purpose:** Checks health of test environment in BTP.

---

### `health:check:prod`
```bash
npm run health:check:prod
```
**Purpose:** Checks health of production environment in BTP.

---

## Performance Scripts

### `test:connection-pool`
```bash
npm run test:connection-pool
```
**Command:** `node scripts/test-connection-pool.js`

**Purpose:** Runs stress tests on database connection pool.

**Default configuration:** Moderate values defined in the script.

---

### `test:connection-pool:light`
```bash
npm run test:connection-pool:light
```
**Command:** `CONCURRENT_REQUESTS=10 TOTAL_REQUESTS=50 node scripts/test-connection-pool.js`

**Purpose:** Light connection pool test.

**Configuration:**
- 10 concurrent requests
- 50 total requests

---

### `test:connection-pool:heavy`
```bash
npm run test:connection-pool:heavy
```
**Command:** `CONCURRENT_REQUESTS=50 TOTAL_REQUESTS=200 node scripts/test-connection-pool.js`

**Purpose:** Heavy connection pool test.

**Configuration:**
- 50 concurrent requests
- 200 total requests

---

### `test:performance-monitoring`
```bash
npm run test:performance-monitoring
```
**Command:** `node scripts/test-performance-monitoring.js`

**Purpose:** Runs application performance monitoring tests.

---

### `test:structured-logging`
```bash
npm run test:structured-logging
```
**Command:** `node scripts/test-structured-logging.js`

**Purpose:** Verifies that structured logging system works correctly.

---

## Help System

### `help`
```bash
npm run help
```

**Purpose:** Shows all available script categories.

**Output:**
```
üìö AVAILABLE SCRIPT CATEGORIES

  dev:help     - Development scripts
  build:help   - Build scripts
  test:help    - Testing scripts
  db:help      - Database scripts
  deploy:help  - Deployment scripts
  health:help  - Health check scripts
  perf:help    - Performance scripts
  clean:help   - Cleanup scripts

üí° TIP: Use help:all to see all commands at once

üìñ Full documentation: package.json.md
```

---

### `help:all`
```bash
npm run help:all
```

**Purpose:** Runs all help commands in sequence, showing all available scripts from all categories.

**When to use:**
- When you want to see all available commands at once
- To get a complete project overview
- For onboarding new developers
- To generate quick documentation

**Output:** Shows all categories with their commands in order:
1. Deployment scripts
2. Development scripts
3. Build scripts
4. Testing scripts
5. Database scripts
6. Health check scripts
7. Performance scripts
8. Cleanup scripts

---

## CDS Configuration

The `cds` section in `package.json` contains environment-specific configurations:

### Defined Environments:
- **`[development]`**: SQLite + dummy auth + test users
- **`[test]`**: In-memory SQLite + test users
- **`[hybrid]`**: HANA + XSUAA (development with real services)
- **`[production]`**: HANA + XSUAA (complete configuration)

### Connection Pool:
- **Hybrid**: 15 min, 75 max
- **Production**: 20 min, 100 max

---

## Best Practices

### Local Development
```bash
# Initial setup
npm run db:deploy:dev
npm run dev

# Iterative development
npm run watch
```

### Testing
```bash
# During development
npm run jest:unit

# Before commit
npm run jest:coverage

# Full validation
npm run jest
```

### Deployment
```bash
# Local build to verify
npm run build

# Deploy to BTP
npm run deploy

# Check health
npm run health:check:dev
```

### Troubleshooting
```bash
# Clean everything
npm run clean
npm run jest:clean

# Complete rebuild
npm run build

# Test debugging
npm run jest:debug
```

---

## Scripts by Development Phase

### Project Start
```bash
npm install
npm run db:deploy:dev
npm run dev
```

### Daily Development
```bash
npm run watch           # Automatic hot reload
npm run jest:unit       # Quick tests
npm run health:check:local  # Check server
```

### Pre-Commit
```bash
npm run jest:coverage   # Tests + coverage
npm run build          # Verify compilation
```

### Pre-Deploy
```bash
npm run jest           # All tests
npm run build:mta      # Complete build
```

### Deployment
```bash
npm run deploy         # Deploy to BTP
npm run health:check:dev  # Verify deployment
```

### Troubleshooting
```bash
npm run jest:debug     # Test cleanup
npm run clean          # Build cleanup
```

---

## Essential Commands Summary

| Command | Usage | Frequency |
|---------|-------|-----------|
| `npm run watch` | Daily development | Daily |
| `npm run dev` | Setup with data | Daily |
| `npm run jest:unit` | Quick tests | Frequent |
| `npm run build` | Verify build | Frequent |
| `npm run deploy` | Deployment | Occasional |
| `npm run clean` | Clean build | Occasional |

---

## Emergency Commands

```bash
# Application won't start
npm run clean
npm install
npm run db:deploy:dev
npm run dev

# Tests fail for no reason
npm run jest:debug
npm run jest:unit

# Corrupted build
npm run clean
npm run build

# Corrupted database
rm db/shiftbook-dev.db
npm run db:deploy:dev
```


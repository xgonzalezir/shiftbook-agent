# Authentication Scripts

Utility scripts for OAuth2 authentication, JWT token generation, and token analysis.

## Available Scripts

### üîë generate-tokens.js
Generates valid JWT bearer tokens for all scopes defined in `xs-security.json`.

```bash
node scripts/auth/generate-tokens.js
# or
node scripts/auth/generate-tokens.js all
```

**Purpose:** Create mock JWT tokens for local testing without needing real XSUAA authentication.

**What it does:**
- Reads scopes from `xs-security.json`
- Generates a valid JWT token for each scope (admin, operator, etc.)
- Saves tokens to `bearer-tokens.json` in the same directory
- Useful for testing API endpoints locally

**Output file:** `scripts/auth/bearer-tokens.json`

---

### üé´ get-auth-token.js
Retrieves a real OAuth2 access token from XSUAA and tests basic service access.

```bash
node scripts/auth/get-auth-token.js
```

**Purpose:** Get a valid access token from the deployed XSUAA service for testing.

**What it does:**
- Authenticates with XSUAA using client credentials
- Obtains a real OAuth2 access token
- Tests basic service endpoints (ShiftBookCategory)
- Displays token info and test results

**Use case:** Testing deployed services with real authentication.

---

### üîç decode-jwt-token.js
Decodes and analyzes JWT tokens to understand their structure and claims.

```bash
node scripts/auth/decode-jwt-token.js <JWT_TOKEN>
```

**Example:**
```bash
node scripts/auth/decode-jwt-token.js "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**Purpose:** Debug authentication issues by inspecting token contents.

**What it displays:**
- Token header (algorithm, type)
- Token payload (claims, scopes, user info)
- Token expiration time
- Issuer and audience information
- All custom claims

**Use case:** Understanding scope assignments, debugging "Unable to map issuer" errors, verifying token structure.

---

## Token Types

### Mock Tokens (generate-tokens.js)
- **Type:** JWT signed with mock secret
- **Validity:** Only for local development
- **Scopes:** All scopes from xs-security.json
- **Expiration:** 24 hours from generation
- **Use case:** Testing locally without XSUAA

### Real Tokens (get-auth-token.js)
- **Type:** OAuth2 access token from XSUAA
- **Validity:** Production-ready
- **Scopes:** Based on service binding
- **Expiration:** ~2 hours (XSUAA default)
- **Use case:** Testing deployed services

## When to Use Each Script

| Script | Use When |
|--------|----------|
| `generate-tokens.js` | Testing locally without Cloud Foundry authentication |
| `get-auth-token.js` | Testing deployed services with real XSUAA |
| `decode-jwt-token.js` | Debugging authentication errors or understanding token structure |
| `test-token-exchange.sh` | Verifying cross-region/cross-subaccount token exchange works |

## Common Workflows

### Local API Testing
```bash
# 1. Generate mock tokens
node scripts/auth/generate-tokens.js

# 2. Use the tokens from bearer-tokens.json in your API calls
curl -H "Authorization: Bearer <token>" http://localhost:4004/shiftbook/ShiftBookService/ShiftBookCategory
```

### Deployed Service Testing
```bash
# 1. Get real token
node scripts/auth/get-auth-token.js

# 2. Copy the token from output and use it
curl -H "Authorization: Bearer <token>" https://your-app.cfapps.us10.hana.ondemand.com/...
```

### Debugging Authentication Issues
```bash
# 1. Get a token from browser (F12 ‚Üí Network ‚Üí Authorization header)

# 2. Decode it to see what's inside
node scripts/auth/decode-jwt-token.js "<token>"

# 3. Check issuer, scopes, expiration, etc.
```

### Testing Token Exchange
```bash
# 1. Obtain a DMC JWT token (e.g., from browser or DMC login)

# 2. Test the token exchange
./scripts/auth/test-token-exchange.sh "<DMC_JWT_TOKEN>"
```

## Output Files

### bearer-tokens.json
Generated by `generate-tokens.js`, contains mock JWT tokens for all scopes:

```json
{
  "admin": {
    "token": "eyJhbGci...",
    "scope": "shiftbook-cap.admin",
    "expires": "2025-10-29T12:00:00Z"
  },
  "operator": {
    "token": "eyJhbGci...",
    "scope": "shiftbook-cap.operator",
    "expires": "2025-10-29T12:00:00Z"
  }
}
```

## Requirements

- Node.js installed
- Dependencies: `npm install`
- For real tokens: Valid XSUAA credentials configured in the script
- For mock tokens: `xs-security.json` file in project root
- For token exchange: Logged into Cloud Foundry (`cf login`)

## Security Notes

‚ö†Ô∏è These scripts contain **hardcoded credentials** for development environments only.

üîí **Never:**
- Commit real production credentials
- Use mock tokens in production
- Share tokens publicly

‚úÖ **Always:**
- Keep credentials in environment variables for production
- Rotate secrets regularly
- Use mock tokens only for local development

## Troubleshooting

### "Cannot find xs-security.json"
- Make sure you're running from the project root
- Verify xs-security.json exists in the root directory

### "401 Unauthorized" when using real tokens
- Check XSUAA credentials are correct
- Verify service binding exists: `cf services`
- Ensure credentials haven't expired

### "Invalid signature" when decoding
- Token might be expired
- Token might be for a different environment
- Use the script just for inspection, signature validation is optional

### "Unable to map issuer" errors
- Check if the token is from a different subaccount or region
- Verify cross-region trust configuration
- Ensure the correct client ID and secret are used for XSUAA

## Related Documentation

- See `__docs/DEPLOYMENT_INSTRUCTIONS.md` for deployment workflows
- See `__docs/CROSS_REGION_TRUST_SETUP.md` for cross-region authentication
- See `scripts/CRUD_TESTING_README.md` for API testing examples
